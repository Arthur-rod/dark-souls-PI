<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../assets/icon/favicon2.png">
    <script src="../js/sessao.js"></script>
    <title>Quiz</title>
    <link rel="stylesheet" href="./css/dashboards.css">
</head>

<body class="dash_body" onload="onloadEsconder(), validarSessao(), melhorResultado()">
  <div class="asideBgFilter"></div>
  <aside>
    <a href="../index.html"><img width="250px" src="../assets/imgs/logoDs.png" alt=""></a>
    <li>
      <ul><a class="aside_buttons" href="./dashboard/cards.html"><p>Graficos Gerais</p></a></ul>
      <ul style="background-color: #0000007e; color: #ff9900;"><a class="aside_buttons" href="../quiz.html"><p>Quiz</p></a></ul>
      <ul><a class="aside_buttons" href="../index.html"><p>Voltar para Tela inicial</p></a></ul>
      <ul class="bt_vermelho"> <a class="aside_buttons" onclick="limparSessao()" href="../login.html"><p>Sair da conta</p></a></ul>
    </li>

  </aside>
  <main>
        <h1 class="titulo_dash">Teste seu conhecimento, <span id="b_usuario"></span>. E honre aqueles que adoram <span id="campeaoUsuario"></span> !</h1>

<div class="cardsD">
          <div class="cardD">
              <h2><span id="melhorPontuacaoQuiz">--</span></h2>
              <p>Sua Melhor Pontuação</p>
          </div>
      </div>
      <div id="pontuacaoEJogo">
          <button id="btnIniciarQuiz" onclick="iniciarQuiz()">INICIAR QUIZ</button>
          
          <div id="pontuacao" class="flex-colunar width-fit-content border-primary">
              <div id="pontuacaoDuranteJogo" class="flex-colunar padding-8">
                  <span class="width-fit-content">Quantidade de acertos: <span id="spanCertas"></span></span>
                  <span class="width-fit-content">Quantidade de erros: <span id="spanErradas"></span></span>
                </div>
                <div id="pontuacaoFinalJogo" class="flex-colunar padding-8">
                    <span id="pontuacaoFinal" class="width-fit-content">Pontuação Final:
                        <span id="spanPontuacaoFinal">***</span>
                    </span>
                    <span id="msgFinal" class="width-fit-content">***</span>
                </div>
            </div>
            
            <div id="jogo" class="width-fit-content flex-colunar border-secondary">
                
                <div id="infoQuestao" class="padding-8">
                    <span>Questão atual: <span id="spanNumeroDaQuestaoAtual"></span> de <span id="qtdQuestoes"></span>
                    questões.</span>
                </div>
                
                <div id="perguntaDaQuestaoAtual" class="padding-8">
                    <span id="spanQuestaoExibida" class="text-bold"></span>
                </div>
                
                <div id="infoAlternativas" class="padding-8">
                    <span><em>Escolha uma opção dentre as abaixo:</em></span>
                </div>
                
                <div id="opcoes" class="flex-colunar padding-8">
                    <span>
                        <input type="radio" id="primeiraOpcao" name="option" class="radio" value="alternativaA" />
                        <label for="primeiraOpcao" class="option" id="labelOpcaoUm"></label>
                    </span>
                    <span>
                        <input type="radio" id="segundaOpcao" name="option" class="radio" value="alternativaB" />
                        <label for="segundaOpcao" class="option" id="labelOpcaoDois"></label>
                    </span>
                    <span>
                        <input type="radio" id="terceiraOpcao" name="option" class="radio" value="alternativaC" />
                        <label for="terceiraOpcao" class="option" id="labelOpcaoTres"></label>
                    </span>
                    <span>
                        <input type="radio" id="quartaOpcao" name="option" class="radio" value="alternativaD" />
                        <label for="quartaOpcao" class="option" id="labelOpcaoQuatro"></label>
                    </span>
                </div>
                
                <div id="botoes" class="flex-colunar padding-8">
                    <button onclick="submeter()" id="btnSubmeter">Submeter resposta</button>
                    <button onclick="avancar()" id="btnProx" disabled>Avançar para próxima questão</button>
                    <button onclick="tentarNovamente()" id="btnTentarNovamente" disabled>Tentar novamente</button>
                </div>
                
            </div>
        </div>
  </main>
</body>

</html>
<script>
    var b_usuario = document.getElementById("b_usuario");
    var campeaoSession = sessionStorage.CAMPEAO_USUARIO;
    const listaDeQuestoes = [

        {
            pergunta: "Qual dos nomes não representa um filho de Gwyn?",
            alternativaA: "Solaire",
            alternativaB: "Gwynevere",
            alternativaC: "Filianore",
            alternativaD: "Yorshka",
            alternativaCorreta: "alternativaA"
        },

        {
            pergunta: "Quem é o Ferreiro que trabalha em Firelink Shrine em DS3?",
            alternativaA: "Vamos",
            alternativaB: "Andre de Astora",
            alternativaC: "Gigante Ferreiro",
            alternativaD: "Rickert de Vinheim",
            alternativaCorreta: "alternativaB"
        },

        {
            pergunta: "Qual reino é a terra natal do NPC Solaire?",
            alternativaA: "Astora",
            alternativaB: "Vinheim",
            alternativaC: "Catarina",
            alternativaD: "Carim",
            alternativaCorreta: "alternativaA"
        },
        {
            pergunta: "Qual é a moeda principal usada para aumentar o nível e comprar itens?",
            alternativaA: "Moedas de Ouro",
            alternativaB: "Almas",
            alternativaC: "Ember",
            alternativaD: "Fragmentos de Estus",
            alternativaCorreta: "alternativaB"
        },
        {
            pergunta: "Em Dark Souls 2, qual é o nome do reino decadente que você explora?",
            alternativaA: "Lothric",
            alternativaB: "Lordran",
            alternativaC: "Drangleic",
            alternativaD: "Yharnam",
            alternativaCorreta: "alternativaC"
        },
        {
            pergunta: "Em DS3, qual dos Lordes das Cinzas é uma figura que consome almas?",
            alternativaA: "Yhorm, o Gigante",
            alternativaB: "Guardiões do Abismo",
            alternativaC: "Aldrich, Devorador de Deuses",
            alternativaD: "Lorian e Lothric",
            alternativaCorreta: "alternativaC"
        }
    ]
 
    let numeroDaQuestaoAtual = 0
    let pontuacaoFinal = 0
    let tentativaIncorreta = 0
    let certas = 0
    let erradas = 0
    let quantidadeDeQuestoes = listaDeQuestoes.length

    function onloadEsconder() {
        document.getElementById('pontuacao').style.display = "none"
        document.getElementById('jogo').style.display = "none"
    }

    function iniciarQuiz() {
        document.getElementById('pontuacao').style.display = "flex"
        document.getElementById('jogo').style.display = "flex"
        document.getElementById('btnIniciarQuiz').style.display = "none"

        document.getElementById('qtdQuestoes').innerHTML = quantidadeDeQuestoes

        preencherHTMLcomQuestaoAtual(0)

        btnSubmeter.disabled = false
        btnProx.disabled = true
        btnTentarNovamente.disabled = true
    }

    function preencherHTMLcomQuestaoAtual(index) {
        habilitarAlternativas(true)
        let questaoAtual = listaDeQuestoes[index]
        numeroDaQuestaoAtual = index
        console.log("questaoAtual")
        console.log(questaoAtual)
        document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = Number(index) + 1
        document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta;
        document.getElementById("labelOpcaoUm").innerHTML = questaoAtual.alternativaA;
        document.getElementById("labelOpcaoDois").innerHTML = questaoAtual.alternativaB;
        document.getElementById("labelOpcaoTres").innerHTML = questaoAtual.alternativaC;
        document.getElementById("labelOpcaoQuatro").innerHTML = questaoAtual.alternativaD;
    }

    function submeter() {
        let options = document.getElementsByName("option");

        let hasChecked = false
        for (let i = 0; i < options.length; i++) {
            if (options[i].checked) {
                hasChecked = true
                break
            }
        }

        if (!hasChecked) {
            alert("Não há alternativas escolhidas. Escolha uma opção.")
        } else {
            btnSubmeter.disabled = true
            btnProx.disabled = false

            habilitarAlternativas(false)

            checarResposta()
        }
    }

    function habilitarAlternativas(trueOrFalse) {
        let opcaoEscolhida = trueOrFalse ? false : true

        primeiraOpcao.disabled = opcaoEscolhida
        segundaOpcao.disabled = opcaoEscolhida
        terceiraOpcao.disabled = opcaoEscolhida
        quartaOpcao.disabled = opcaoEscolhida

    }

    function avancar() {
        btnProx.disabled = true
        btnSubmeter.disabled = false

        desmarcarRadioButtons()

        if (numeroDaQuestaoAtual < quantidadeDeQuestoes - 1) {
            preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual)
        } else if (numeroDaQuestaoAtual == quantidadeDeQuestoes - 1) {
            alert("Atenção... a próxima é a ultima questão!")
            preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual)
        } else {
            finalizarJogo()
        }
        limparCoresBackgroundOpcoes()
    }

    function tentarNovamente() {
        window.location.reload()
    }

    function checarResposta() {
        let questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual]
        let respostaQuestaoAtual = questaoAtual.alternativaCorreta

        let options = document.getElementsByName("option");

        let idAlternativaCorreta = null
        let isRespostaCerta = false

        options.forEach((option) => {
            if (option.value === respostaQuestaoAtual) {
                idAlternativaCorreta = option.labels[0].id
            }
        })
        
        options.forEach((option) => {
            if (option.checked === true && option.value === respostaQuestaoAtual) {
                pontuacaoFinal++
                certas++
                isRespostaCerta = true
            } else if (option.checked && option.value !== respostaQuestaoAtual) {
                let wrongLabelId = option.labels[0].id
                document.getElementById(wrongLabelId).classList.add("text-danger-with-bg")
                erradas++
            }
        })

        if (!isRespostaCerta) {
            document.getElementById(idAlternativaCorreta).classList.add("text-success-with-bg")
        }

        document.getElementById("spanCertas").innerHTML = certas
        document.getElementById("spanErradas").innerHTML = erradas
        numeroDaQuestaoAtual++
    }

    function limparCoresBackgroundOpcoes() {
        let options = document.getElementsByName("option");
        options.forEach((option) => {
            document.getElementById(option.labels[0].id).classList.remove("text-danger-with-bg")
            document.getElementById(option.labels[0].id).classList.remove("text-success-with-bg")
        })
    }

    function desmarcarRadioButtons() {
        let options = document.getElementsByName("option");
        for (let i = 0; i < options.length; i++) {
            options[i].checked = false;
        }
    }

    function finalizarJogo() {
        let textoParaMensagemFinal = null
        let classComCoresParaMensagemFinal = null
        let porcentagemFinalDeAcertos = pontuacaoFinal / quantidadeDeQuestoes
        let idUsuario = sessionStorage.ID_USUARIO;
        const idQuiz = 1;

        fetch("/quiz/salvarPontuacao", {
           method: "POST",
           headers: {
               "Content-Type": "application/json"
           },
           body: JSON.stringify({
               idUsuario: idUsuario,
               idQuiz: idQuiz,
               pontuacaoFinal: pontuacaoFinal
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                console.log("Pontuação salva com sucesso!");
            } else {
                console.error("Falha ao salvar a pontuação.");
                resposta.text().then(text => console.error(text));
            }
        }).catch(function (erro) {
        console.error(`Erro ao tentar salvar a pontuação: ${erro}`);
        });

        if (porcentagemFinalDeAcertos <= 0.3) {
            textoParaMensagemFinal = "Parece que você não estudou..."
            classComCoresParaMensagemFinal = "text-danger-with-bg"
        }
        else if (porcentagemFinalDeAcertos > 0.3 && porcentagemFinalDeAcertos < 0.9) {
            textoParaMensagemFinal = "Pode melhorar na próxima, hein!"
            classComCoresParaMensagemFinal = "text-warning-with-bg"
        }
        else if (porcentagemFinalDeAcertos >= 0.9) {
            textoParaMensagemFinal = "Uau, parabéns!"
            classComCoresParaMensagemFinal = "text-success-with-bg"
        }

        textoParaMensagemFinal += "<br> Você acertou " + Math.round((porcentagemFinalDeAcertos)*100) + "% das questões."


        document.getElementById('msgFinal').innerHTML = textoParaMensagemFinal
        document.getElementById('msgFinal').classList.add(classComCoresParaMensagemFinal) 
        document.getElementById('spanPontuacaoFinal').innerHTML = pontuacaoFinal

        document.getElementById('jogo').classList.add("text-new-gray") 

        btnProx.disabled = true
        btnSubmeter.disabled = true
        btnTentarNovamente.disabled = false

    }

    function melhorResultado() { 

        let idUsuario = sessionStorage.ID_USUARIO;
        let idQuiz = 1;

        if (idUsuario) {

            fetch(`/quiz/melhorResultado/${idUsuario}/${idQuiz}`, { cache: 'no-store' })
                .then(response => {
                    if (response.ok) {
                        response.json().then(resposta => {

                            if (resposta.melhor_pontuacao !== undefined && resposta.melhor_pontuacao !== null) {
                                melhorPontuacaoQuiz.innerHTML = resposta.melhor_pontuacao;
                            } else {
                                melhorPontuacaoQuiz.innerHTML = '0';
                            }
                        });
                    } else if (response.status === 404) {
                        melhorPontuacaoQuiz.innerHTML = '0';
                    } else {
                        console.error(`Erro ao obter o melhor resultado.`);
                    }
                })
                .catch(error => {
                    console.error(`Erro ao obter o melhor resultado. ${error.message}`);
                    melhorPontuacaoQuiz.innerHTML = 'Erro';
                });
        } else {
            melhorPontuacaoQuiz.innerHTML = 'N/A';
        }
    }
</script>